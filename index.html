<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ğŸ“¦ å­˜è¯ç»ˆç«¯(è°ƒè¯•ç‰ˆ)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { background-color: #000; color: white; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
    .hidden { display: none !important; }

    #scanner-container {
      width: 100%; height: 50vh; background: #000; border-radius: 12px; overflow: hidden; border: 2px solid #333;
      position: relative;
    }
    #scanner-container video { object-fit: cover !important; width: 100% !important; height: 100% !important; }
    .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    .recording-border { box-shadow: inset 0 0 0 6px red; animation: pulse-red 2s infinite; }
    @keyframes pulse-red { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

    .scan-line {
      position: absolute; width: 100%; height: 3px; background: #ef4444; top: 0;
      animation: scan 1.2s cubic-bezier(0.4, 0, 0.2, 1) infinite;
      box-shadow: 0 0 15px #ef4444, 0 0 30px #ef4444; opacity: 0.9; z-index: 20;
    }
    @keyframes scan { 0% { top: 10%; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 90%; opacity: 0; } }

    input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #3b82f6; cursor: pointer;
      margin-top: -10px; box-shadow: 0 0 10px rgba(59,130,246,0.5); border: 2px solid white;
    }
  </style>
</head>

<body class="p-4 flex flex-col h-screen pb-safe">

  <!-- é¡¶éƒ¨ -->
  <div class="flex justify-between items-center mb-2">
    <div>
      <h1 class="text-lg font-bold text-white flex items-center gap-2">
        ğŸš€ å­˜è¯ç»ˆç«¯
        <span class="text-[10px] bg-yellow-600 px-1 rounded font-mono" id="sys-badge">DEBUG</span>
      </h1>
      <div class="text-[10px] text-gray-400 mt-1 font-mono">
        iOSåŸç”Ÿè¯†åˆ«: <span id="bd-badge" class="text-gray-500">--</span>
        Â· æµ‹è¯•æ¨¡å¼: <span id="test-badge" class="text-gray-500">OFF</span>
      </div>
    </div>

    <div class="flex gap-2">
      <button onclick="toggleDebug()" class="bg-gray-800 text-xs px-2 py-1 rounded border border-gray-600 text-yellow-400">ğŸ è°ƒè¯•æ—¥å¿—</button>

      <!-- æ–°å¢ï¼šiOS æ‰«ææµ‹è¯• -->
      <button onclick="runIosScanTest()" id="ios-test-btn"
              class="bg-gray-800 text-xs px-2 py-1 rounded border border-gray-600 text-pink-300">
        ğŸ iOSæµ‹è¯•
      </button>

      <button onclick="toggleTorch()" id="torch-btn" class="bg-gray-800 p-2 rounded-full border border-gray-600 active:bg-yellow-600 disabled:opacity-50 transition-colors">ğŸ”¦</button>
    </div>
  </div>

  <!-- è°ƒè¯•çª—å£ -->
  <div id="debug-console" class="hidden fixed top-0 left-0 w-full h-full bg-black/95 z-[100] p-4 font-mono text-xs overflow-y-auto text-green-400">
    <div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-2 sticky top-0 bg-black">
      <span class="font-bold text-white">ç³»ç»Ÿæ—¥å¿—</span>
      <div class="flex gap-2">
        <button onclick="clearLogs()" class="text-blue-400 border border-blue-900 px-2 rounded">æ¸…ç©º</button>
        <button onclick="toggleDebug()" class="text-red-500 border border-red-900 px-2 rounded">å…³é—­ X</button>
      </div>
    </div>
    <div id="debug-content" class="space-y-1 pb-20"></div>
  </div>

  <!-- æ‰«æåŒº -->
  <div id="scanner-wrapper" class="relative shadow-2xl rounded-xl overflow-hidden bg-gray-900">
    <div id="scanner-container"></div>

    <div class="absolute top-4 left-4 bg-black/60 backdrop-blur px-3 py-1 rounded border border-white/20 z-10">
      <p class="text-[10px] text-gray-400 uppercase">å½“å‰å½•åˆ¶</p>
      <p class="text-xl font-mono text-green-400 font-bold tracking-wider" id="current-barcode">READY</p>
      <p class="text-[10px] text-gray-500 font-mono mt-1" id="scan-health">scan: --</p>
    </div>

    <div class="absolute top-4 right-4 bg-red-600 text-white px-2 py-1 rounded text-xs font-bold hidden z-10 animate-pulse" id="rec-badge">â— REC</div>
    <div id="scan-line-el" class="scan-line hidden"></div>

    <div id="toast" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full text-center pointer-events-none opacity-0 transition-opacity duration-200 z-50 px-4">
      <span class="bg-black/90 text-white px-6 py-4 rounded-xl text-xl font-bold shadow-2xl border border-gray-500 backdrop-blur-md block" id="toast-text"></span>
    </div>
  </div>

  <!-- å˜ç„¦ -->
  <div class="mt-4 mb-2 bg-gray-900 p-3 rounded-lg border border-gray-800 flex items-center gap-3">
    <span class="text-xs text-gray-400">1x</span>
    <input type="range" id="zoom-slider" min="1" max="5" step="0.1" value="1" disabled oninput="applyZoom(this.value)" />
    <span class="text-xs text-gray-400">5x</span>
  </div>

  <!-- åº•éƒ¨æŒ‰é’® -->
  <div class="flex-1 flex flex-col justify-end gap-3">
    <button onclick="startPipeline()" id="main-btn"
            class="w-full bg-blue-600 hover:bg-blue-500 text-white py-4 rounded-xl font-bold text-xl shadow-lg transition-all border border-blue-400/30 active:scale-95">
      ğŸ“¸ å¯åŠ¨æ‰«æ
    </button>
    <div class="flex justify-between items-center px-1">
      <div class="flex gap-4">
        <a href="#" onclick="showHistory()" class="text-sm text-gray-400 hover:text-white">ğŸ“‚ å†å²</a>
        <a href="#" onclick="manualTriggerDialog()" class="text-sm text-gray-400 hover:text-white">âŒ¨ï¸ è¾“å•</a>
      </div>
      <span id="storage-info" class="text-[10px] text-gray-600 font-mono">å­˜å‚¨: --</span>
    </div>
  </div>

  <!-- å†å² -->
  <div id="history-modal" class="fixed inset-0 bg-black/95 z-50 hidden flex flex-col p-4 animate-fade-in">
    <div class="flex justify-between items-center mb-4 border-b border-gray-800 pb-2">
      <h2 class="text-xl font-bold text-white">ğŸ“œ å†å²è®°å½•</h2>
      <button onclick="closeHistory()" class="text-3xl text-gray-400 hover:text-white">&times;</button>
    </div>
    <input id="search-input" class="bg-gray-800 p-3 rounded-lg text-white border border-gray-700 w-full mb-4 outline-none"
           placeholder="ğŸ” æœç´¢..." oninput="doSearch()" />
    <div id="video-list" class="flex-1 overflow-y-auto space-y-2 pb-4"></div>
    <div class="mt-2 pt-2 border-t border-gray-800 flex gap-2">
      <button onclick="clearOldData()" class="flex-1 bg-yellow-900/30 text-yellow-500 text-xs py-3 rounded-lg">ğŸ§¹ æ¸…ç†30å¤©å‰</button>
      <button onclick="clearAllData()" class="flex-1 bg-red-900/30 text-red-500 text-xs py-3 rounded-lg">ğŸ—‘ï¸ å¼ºåˆ¶æ¸…ç©º</button>
    </div>
  </div>

  <!-- æ’­æ”¾å™¨ -->
  <div id="player-modal" class="fixed inset-0 bg-black z-[60] hidden flex flex-col justify-center bg-opacity-95">
    <button onclick="closePlayer()" class="absolute top-6 right-6 text-white text-3xl z-20 bg-gray-800 rounded-full w-12 h-12 flex items-center justify-center">&times;</button>
    <video id="main-player" controls playsinline class="w-full max-h-[80vh] bg-black"></video>
    <div class="text-center mt-6">
      <h3 id="player-title" class="text-xl font-mono text-white mb-4"></h3>
      <a id="download-btn" href="#" download class="bg-blue-600 text-white px-8 py-3 rounded-full font-bold">ğŸ’¾ ä¿å­˜</a>
    </div>
  </div>

  <script>
    // ---------- æ—¥å¿—ç³»ç»Ÿ ----------
    function log(msg, type='info') {
      const el = document.getElementById('debug-content');
      const div = document.createElement('div');
      const time = new Date().toLocaleTimeString().split(' ')[0];
      div.innerHTML = `<span class="text-gray-500">[${time}]</span> ${msg}`;
      if(type==='error') div.className = "text-red-400 font-bold border-l-2 border-red-500 pl-2";
      if(type==='warn') div.className = "text-yellow-400";
      if(type==='success') div.className = "text-green-400";
      el.appendChild(div);
      const container = document.getElementById('debug-console');
      if(!container.classList.contains('hidden')) container.scrollTop = container.scrollHeight;
      console.log(msg);
    }
    function toggleDebug(){ document.getElementById('debug-console').classList.toggle('hidden'); }
    function clearLogs(){ document.getElementById('debug-content').innerHTML=''; }

    window.onerror = function(msg, url, line) {
      log(`ç³»ç»Ÿé”™è¯¯: ${msg} (Line:${line})`, 'error');
      return false;
    };

    // ---------- é…ç½® ----------
    const DB_NAME = 'PipelineDB';
    const DUPLICATE_INTERVAL_MS = 1500;
    const BITRATE = 25000000;

    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

    const SUPPORTED_FORMATS = [
      Html5QrcodeSupportedFormats.CODE_128,
      Html5QrcodeSupportedFormats.EAN_13,
      Html5QrcodeSupportedFormats.EAN_8,
      Html5QrcodeSupportedFormats.CODE_39,
      Html5QrcodeSupportedFormats.UPC_A,
      Html5QrcodeSupportedFormats.ITF
    ];

    let db, html5QrCode, mediaRecorder;
    let recordedChunks = [], isRunning = false, isRecording = false;
    let currentCode = null, lastCodeTime = 0;
    let stream = null, videoTrack = null, trackCapabilities = {};

    // iOS åŸç”Ÿ BarcodeDetector å…œåº•
    let bd = null;
    let bdTimer = null;
    let bdRunning = false;
    let bdLoopMs = 220;          // åŸç”Ÿæ£€æµ‹å¾ªç¯é—´éš”
    let bdBusy = false;
    let bdLast = 0;

    // æ‰«æå¥åº·ç»Ÿè®¡
    let scanStat = { hit:0, nativeHit:0, last:'--', since:Date.now() };
    function updateHealth(extra='') {
      const s = document.getElementById('scan-health');
      const sec = Math.max(1, Math.floor((Date.now() - scanStat.since)/1000));
      s.innerText = `scan: hit=${scanStat.hit} native=${scanStat.nativeHit} ${extra} Â· ${sec}s`;
    }

    // éŸ³æ•ˆ
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function beep(f=1200,d=80){
      if(audioCtx.state==='suspended') audioCtx.resume();
      const o=audioCtx.createOscillator(),g=audioCtx.createGain();
      o.type='square'; o.frequency.value=f;
      o.connect(g); g.connect(audioCtx.destination);
      o.start(); setTimeout(()=>o.stop(),d);
    }
    function errorBeep(){
      const n=audioCtx.currentTime,o=audioCtx.createOscillator(),g=audioCtx.createGain();
      o.type='sawtooth'; o.frequency.value=150;
      o.connect(g); g.connect(audioCtx.destination);
      o.start(n); o.stop(n+0.4);
    }

    // ---------- DB ----------
    const initDB=()=>{
      log("æ­£åœ¨è¿æ¥æ•°æ®åº“...");
      const r=indexedDB.open(DB_NAME,1);
      r.onupgradeneeded=e=>{
        db=e.target.result;
        if(!db.objectStoreNames.contains('videos')){
          const store = db.createObjectStore('videos',{keyPath:'id',autoIncrement:true});
          store.createIndex('barcode','barcode',{unique:false});
          // ä¿®å¤ï¼šä½ åé¢ clearOldData ç”¨äº† created ç´¢å¼•ï¼Œè¿™é‡Œå¿…é¡»åˆ›å»º
          store.createIndex('created','created',{unique:false});
        }
      };
      r.onsuccess=e=>{ db=e.target.result; log("æ•°æ®åº“è¿æ¥æˆåŠŸ", 'success'); updateStorageInfo(); };
      r.onerror=e=>{ log("æ•°æ®åº“é”™è¯¯: "+e.target.error, 'error'); };
    };

    const checkDuplicate=(c)=>new Promise(r=>{
      if(!db) return r(false);
      db.transaction(['videos'],'readonly')
        .objectStore('videos').index('barcode')
        .getKey(c).onsuccess=e=>r(!!e.target.result);
    });

    const saveVideo=(b,blob)=>{
      if(!b||!blob||blob.size===0) return;
      log(`æ­£åœ¨ä¿å­˜è§†é¢‘: ${b} (${(blob.size/1024/1024).toFixed(2)}MB)`);
      db.transaction(['videos'],'readwrite').objectStore('videos')
        .add({barcode:b,blob:blob,created:Date.now(),size:blob.size})
        .onsuccess=()=>{
          showToast(`âœ… ${b} å·²å½’æ¡£`);
          updateStorageInfo();
          log("ä¿å­˜æˆåŠŸ", 'success');
        };
    };

    // ---------- æ ¸å¿ƒï¼šå¯åŠ¨æ‰«æ ----------
    function buildQrConfig(preset = null) {
      // é‡ç‚¹ï¼šiOS åˆ«ç”¨å›ºå®šå° qrboxï¼›ç»™å®ƒæ›´å¤§/æˆ–å…¨ç”»é¢
      const vw = Math.min(window.innerWidth, 480);
      const baseBoxW = Math.floor(vw * 0.92);
      const baseBoxH = Math.floor(baseBoxW * 0.35); // æ¡ç æ›´æ‰ï¼Œç»™å®ƒæ›´é•¿çš„æ¨ªå‘åŒºåŸŸ

      const defaults = {
        fps: isIOS ? 12 : 30,
        // iOS æ¨èï¼šå¤§æ¡†ç”šè‡³å…¨ç”»é¢ï¼ˆnullï¼‰æ›´å®¹æ˜“æ‰«åˆ°æ¡ç 
        qrbox: isIOS ? { width: baseBoxW, height: baseBoxH } : { width: 300, height: 150 },
        aspectRatio: isIOS ? (16/9) : 1.0,
        formatsToSupport: SUPPORTED_FORMATS,
        useBarCodeDetectorIfSupported: !isIOS, // ä»ä¿ç•™ï¼šiOS ç”¨æˆ‘ä»¬è‡ªå·±çš„åŸç”Ÿå…œåº•ï¼ˆæ›´å¯æ§ï¼‰
        disableFlip: isIOS ? true : false
      };

      if (!preset) return defaults;

      // preset å¯è¦†ç›– defaults
      return {
        ...defaults,
        ...preset
      };
    }

    function buildConstraints(preset = null) {
      // iOS å»ºè®®ï¼šåˆ†è¾¨ç‡ä¸è¦å¤ªé«˜ï¼ˆJS è§£ç å¾ˆåƒæ€§èƒ½ï¼‰
      const base = {
        facingMode: "environment",
        focusMode: "continuous"
      };

      const iosDefault = {
        width: { ideal: 1280 },
        height: { ideal: 720 }
      };

      const andDefault = {
        width: { ideal: 1920 },
        height: { ideal: 1080 }
      };

      const c = { ...base, ...(isIOS ? iosDefault : andDefault) };
      if (!preset) return c;

      // preset å…è®¸è¦†ç›– ideal
      return { ...c, ...preset };
    }

    async function startPipeline(preset = null) {
      if (isRunning) { stopPipeline(); return; }

      scanStat = { hit:0, nativeHit:0, last:'--', since:Date.now() };
      updateHealth();

      log("--- å¼€å§‹å¯åŠ¨æµç¨‹ ---");
      log(`è®¾å¤‡ç±»å‹: ${isIOS ? 'iOS' : 'Android/PC'}`);

      try {
        if (!html5QrCode) html5QrCode = new Html5Qrcode("scanner-container");

        const constraints = buildConstraints(preset?.constraints || null);
        const config = buildQrConfig(preset?.config || null);

        log(`è¯·æ±‚åˆ†è¾¨ç‡: ${constraints.width?.ideal || '--'}x${constraints.height?.ideal || '--'}`);
        log(`æ‰«æå‚æ•°: fps=${config.fps}, qrbox=${config.qrbox ? (config.qrbox.width+'x'+config.qrbox.height) : 'FULL'}, aspect=${config.aspectRatio}, flip=${!config.disableFlip}`);

        const qrCodeSuccessCallback = (decodedText, decodedResult) => {
          scanStat.hit++;
          scanStat.last = decodedText;
          updateHealth(`last=${decodedText}`);
          handleBarcode(decodedText);
        };

        log("æ­£åœ¨å¯åŠ¨æ‘„åƒå¤´...");
        await html5QrCode.start(
          constraints,
          config,
          qrCodeSuccessCallback,
          (errMsg)=>{ /* å®æ—¶æ‰«æé”™è¯¯ä¸€èˆ¬å¾ˆå¤šï¼Œä¸åˆ·å± */ }
        );

        log("æ‘„åƒå¤´å¯åŠ¨æˆåŠŸ!", 'success');

        const videoElement = document.querySelector("#scanner-container video");
        if(videoElement) {
          stream = videoElement.srcObject;
          videoTrack = stream.getVideoTracks()[0];
          const settings = videoTrack.getSettings();
          log(`å®é™…åˆ†è¾¨ç‡: ${settings.width}x${settings.height}`);

          trackCapabilities = videoTrack.getCapabilities ? videoTrack.getCapabilities() : {};
          log(`æ”¯æŒå˜ç„¦: ${!!trackCapabilities.zoom}, æ”¯æŒæ‰‹ç”µ: ${!!trackCapabilities.torch}`);

          const slider = document.getElementById('zoom-slider');
          if (trackCapabilities.zoom) {
            slider.min = trackCapabilities.zoom.min;
            slider.max = trackCapabilities.zoom.max;
            slider.step = 0.1;

            let z = isIOS ? 2.0 : 1.2;
            z = Math.min(parseFloat(slider.max), z);
            slider.value = z;
            slider.disabled = false;
            await applyZoom(z);
            log(`åº”ç”¨åˆå§‹å˜ç„¦: ${z}x`);
          } else {
            slider.disabled = true;
            log("å½“å‰æ‘„åƒå¤´ä¸æ”¯æŒå˜ç„¦", 'warn');
          }

          document.getElementById('torch-btn').disabled = !trackCapabilities.torch;
        }

        isRunning = true;
        updateUIState(true);

        // iOS åŸç”Ÿ BarcodeDetector å…œåº•ï¼šèƒ½ç”¨å°±å¼€
        setupBarcodeDetector();
        startNativeDetectorLoop();

      } catch (err) {
        log(`å¯åŠ¨å´©æºƒ: ${err.message}`, 'error');
        alert("å¯åŠ¨å¤±è´¥ï¼Œè¯·æŸ¥çœ‹è°ƒè¯•æ—¥å¿—");
        stopPipeline();
      }
    }

    async function stopPipeline() {
      log("æ­£åœ¨åœæ­¢...");
      stopRecording(true);

      stopNativeDetectorLoop();

      try {
        if (html5QrCode) await html5QrCode.stop();
        log("æ‰«æå™¨å·²åœæ­¢");
      } catch(e){
        log("åœæ­¢æ‰«æå™¨å¤±è´¥:"+e, 'warn');
      }

      isRunning = false;
      updateUIState(false);
    }

    async function applyZoom(val) {
      if(videoTrack && trackCapabilities.zoom) {
        try {
          await videoTrack.applyConstraints({ advanced: [{ zoom: parseFloat(val) }] });
        } catch(e) {
          log("å˜ç„¦å¤±è´¥:"+e, 'warn');
        }
      }
    }

    let torchOn = false;
    async function toggleTorch() {
      if(videoTrack && trackCapabilities.torch) {
        torchOn = !torchOn;
        try {
          await videoTrack.applyConstraints({ advanced: [{ torch: torchOn }] });
          document.getElementById('torch-btn').classList.toggle('bg-yellow-500', torchOn);
          log(`æ‰‹ç”µç­’: ${torchOn}`);
        } catch(e) {
          log("æ‰‹ç”µç­’å¤±è´¥:"+e, 'error');
        }
      } else {
        log("ä¸æ”¯æŒæ‰‹ç”µç­’", 'warn');
      }
    }

    // ---------- iOS åŸç”Ÿ BarcodeDetector å…œåº• ----------
    function setupBarcodeDetector() {
      const badge = document.getElementById('bd-badge');

      if (!isIOS) {
        badge.innerText = 'N/A';
        badge.className = 'text-gray-500';
        return;
      }

      if ('BarcodeDetector' in window) {
        try {
          // å¸¸è§æ ¼å¼åˆ—è¡¨ï¼ˆiOS æ”¯æŒé›†åˆå› ç‰ˆæœ¬ä¸åŒï¼Œä¸èƒ½å…¨å†™æ­»ï¼‰
          // å°½é‡å†™â€œå¸¸è§çš„â€é¿å…åˆ›å»ºå¤±è´¥
          bd = new BarcodeDetector({
            formats: ['code_128','ean_13','ean_8','code_39','upc_a','itf']
          });
          badge.innerText = 'ON';
          badge.className = 'text-green-400 font-bold';
          log("iOS åŸç”Ÿ BarcodeDetector: å¯ç”¨ âœ…", 'success');
        } catch (e) {
          bd = null;
          badge.innerText = 'ERR';
          badge.className = 'text-red-400 font-bold';
          log("iOS BarcodeDetector åˆå§‹åŒ–å¤±è´¥: " + e, 'warn');
        }
      } else {
        bd = null;
        badge.innerText = 'OFF';
        badge.className = 'text-yellow-400 font-bold';
        log("iOS åŸç”Ÿ BarcodeDetector: ä¸æ”¯æŒï¼ˆç³»ç»Ÿç‰ˆæœ¬å¯èƒ½åä½ï¼‰", 'warn');
      }
    }

    function startNativeDetectorLoop() {
      if (!isIOS || !bd || !stream) return;
      if (bdRunning) return;

      bdRunning = true;
      log(`å¯åŠ¨ iOS åŸç”Ÿå…œåº•æ‰«æå¾ªç¯ (æ¯ ${bdLoopMs}ms)`, 'success');

      const videoEl = document.querySelector("#scanner-container video");
      if (!videoEl) { log("æ‰¾ä¸åˆ° video å…ƒç´ ï¼Œæ— æ³•å¯åŠ¨åŸç”Ÿå…œåº•", 'warn'); return; }

      // ç”¨ canvas æˆªå¸§ç»™ BarcodeDetector
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d', { willReadFrequently: true });

      bdTimer = setInterval(async () => {
        if (!bdRunning) return;
        if (bdBusy) return;

        // é™ä½é¢‘ç‡/é¿å…å¡é¡¿
        const now = Date.now();
        if (now - bdLast < bdLoopMs) return;
        bdLast = now;

        try {
          bdBusy = true;

          const w = videoEl.videoWidth || 0;
          const h = videoEl.videoHeight || 0;
          if (!w || !h) return;

          // æˆªä¸€å¼ â€œæ›´é€‚åˆæ¡ç â€çš„ä¸­éƒ¨æ¨ªæ¡åŒºåŸŸï¼ˆæ¡ç ä¸€èˆ¬æ¨ªå‘ï¼‰
          // è¿™æ ·æ¯”å…¨ç”»é¢æ›´å¿«ã€ä¹Ÿæ›´èšç„¦
          const cropH = Math.floor(h * 0.45);
          const cropY = Math.floor((h - cropH) / 2);
          const cropX = 0;
          const cropW = w;

          canvas.width = cropW;
          canvas.height = cropH;
          ctx.drawImage(videoEl, cropX, cropY, cropW, cropH, 0, 0, cropW, cropH);

          const results = await bd.detect(canvas);
          if (results && results.length) {
            const raw = results[0].rawValue;
            if (raw) {
              scanStat.nativeHit++;
              updateHealth(`native=${raw}`);
              log(`ğŸ åŸç”Ÿè¯†åˆ«åˆ°: ${raw}`, 'success');
              handleBarcode(raw);
            }
          }
        } catch (e) {
          // ä¸åˆ·å±ï¼šåªå¶å°”æç¤º
          // log("åŸç”Ÿå…œåº•æ‰«æå¼‚å¸¸: "+e, 'warn');
        } finally {
          bdBusy = false;
        }
      }, 80); // setInterval é¢‘ç‡é«˜ä¸€ç‚¹ï¼Œä½†å†…éƒ¨ç”¨ bdLoopMs æ§åˆ¶
    }

    function stopNativeDetectorLoop() {
      bdRunning = false;
      if (bdTimer) clearInterval(bdTimer);
      bdTimer = null;
    }

    // ---------- æ¡ç é€»è¾‘ ----------
    async function handleBarcode(code) {
      log(`è¯†åˆ«åˆ°: ${code}`, 'success');

      const now = Date.now();

      if (code === currentCode && (now - lastCodeTime < DUPLICATE_INTERVAL_MS)) return;

      if (code !== currentCode) {
        if (await checkDuplicate(code)) {
          if (now - lastCodeTime < DUPLICATE_INTERVAL_MS) return;
          errorBeep();
          showToast(`âš ï¸ é‡å¤: ${code}`, true);
          lastCodeTime = now;
          return;
        }
      }

      lastCodeTime = now;
      triggerSlice(code);
    }

    function triggerSlice(newCode) {
      beep(1200, 80);

      const el = document.getElementById('current-barcode');
      el.innerText = newCode;
      el.className = "text-2xl font-mono text-white font-bold tracking-widest scale-110 transition-transform";
      setTimeout(()=> el.className = "text-xl font-mono text-green-400 font-bold tracking-wider", 200);

      if (isRecording) stopRecording();
      currentCode = newCode;
      startRecording();
    }

    function startRecording() {
      if (!stream) { log("å½•åˆ¶å¤±è´¥: æ— è§†é¢‘æµ", 'error'); return; }
      recordedChunks = [];

      let options = { mimeType: 'video/mp4', videoBitsPerSecond: BITRATE };
      if (!MediaRecorder.isTypeSupported('video/mp4')) {
        options = { mimeType: 'video/webm', videoBitsPerSecond: BITRATE };
      }

      try {
        mediaRecorder = new MediaRecorder(stream, options);
      } catch (e) {
        log("é«˜æ¸…å½•åˆ¶å¤±è´¥ï¼Œé™çº§å°è¯•", 'warn');
        mediaRecorder = new MediaRecorder(stream);
      }

      mediaRecorder.ondataavailable = e => { if(e.data.size > 0) recordedChunks.push(e.data); };

      let clipCode = currentCode;
      mediaRecorder.onstop = () => {
        log(`å½•åˆ¶ç»“æŸ: ${clipCode}`);
        const finalType = recordedChunks[0] ? recordedChunks[0].type : options.mimeType;
        saveVideo(clipCode, new Blob(recordedChunks, { type: finalType }));
      };

      mediaRecorder.start();
      isRecording = true;
      log(`å¼€å§‹å½•åˆ¶: ${currentCode}`);

      document.getElementById('rec-badge').classList.remove('hidden');
      document.getElementById('scanner-container').classList.add('recording-border');
    }

    function stopRecording(force = false) {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
      isRecording = false;
      document.getElementById('rec-badge').classList.add('hidden');
      document.getElementById('scanner-container').classList.remove('recording-border');
      if(force) document.getElementById('current-barcode').innerText = "PAUSED";
    }

    function manualTriggerDialog(){
      const c = prompt("è¾“å…¥å•å·:");
      if(c && c.trim()) handleBarcode(c.trim());
    }

    function updateUIState(running) {
      const btn = document.getElementById('main-btn'), line = document.getElementById('scan-line-el');
      if (running) {
        btn.innerText = "â¹ åœæ­¢";
        btn.className = "w-full bg-red-600 text-white py-4 rounded-xl font-bold text-xl shadow-lg animate-pulse";
        line.classList.remove('hidden');
      } else {
        btn.innerText = "ğŸ“¸ å¯åŠ¨æ‰«æ";
        btn.className = "w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-xl shadow-lg";
        line.classList.add('hidden');
      }
    }

    function showToast(msg, isErr) {
      const t = document.getElementById('toast'), txt = document.getElementById('toast-text');
      txt.innerText = msg;
      txt.className = isErr
        ? "bg-yellow-500 text-black px-6 py-4 rounded-xl text-xl font-bold shadow-2xl border-4 border-yellow-600 block"
        : "bg-green-600/90 text-white px-6 py-4 rounded-xl text-xl font-bold shadow-2xl backdrop-blur block";
      t.classList.remove('opacity-0');
      setTimeout(() => t.classList.add('opacity-0'), 1500);
    }

    async function updateStorageInfo() {
      try {
        const { usage } = await navigator.storage.estimate();
        document.getElementById('storage-info').innerText = `å·²ç”¨: ${(usage/1024/1024).toFixed(0)} MB`;
      } catch(e){}
    }

    function showHistory() { document.getElementById('history-modal').classList.remove('hidden'); doSearch(); }
    function closeHistory() { document.getElementById('history-modal').classList.add('hidden'); }

    function openPlayer(blob, title) {
      const url = URL.createObjectURL(blob), v = document.getElementById('main-player');
      v.src = url; v.play();
      document.getElementById('player-title').innerText = title;
      const d = document.getElementById('download-btn');
      d.href = url; d.download = `${title}.mp4`;
      document.getElementById('player-modal').classList.remove('hidden');
    }

    function closePlayer() {
      document.getElementById('main-player').pause();
      document.getElementById('player-modal').classList.add('hidden');
    }

    function doSearch() {
      const q = document.getElementById('search-input').value.trim();
      const list = document.getElementById('video-list');
      list.innerHTML = '';
      let lim = 50;

      db.transaction(['videos'], 'readonly').objectStore('videos')
        .openCursor(null, 'prev').onsuccess = e => {
          const c = e.target.result;
          if(c && lim > 0) {
            if(!q || c.value.barcode.includes(q)) {
              const i = c.value, d = new Date(i.created);
              const ds = `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${d.getMinutes().toString().padStart(2,'0')}`;
              const div = document.createElement('div');
              div.className = "bg-gray-800 p-3 rounded-lg border-l-4 border-blue-500 mb-2 flex justify-between items-center cursor-pointer active:bg-gray-700";
              div.onclick = () => openPlayer(i.blob, i.barcode);
              div.innerHTML = `<div>
                <div class="font-bold text-lg font-mono">${i.barcode}</div>
                <div class="text-xs text-gray-500">${ds} Â· ${(i.size/1024/1024).toFixed(1)}MB</div>
              </div><div class="text-2xl text-blue-500">â–¶</div>`;
              list.appendChild(div);
              lim--;
            }
            c.continue();
          }
        };
    }

    function clearOldData() {
      if(!confirm("åˆ é™¤30å¤©å‰çš„æ•°æ®ï¼Ÿ")) return;
      const m = Date.now()-(30*24*60*60*1000);
      const tx = db.transaction(['videos'],'readwrite');
      const store = tx.objectStore('videos');
      const idx = store.index('created');

      idx.getAllKeys(IDBKeyRange.upperBound(m)).onsuccess = e => {
        const keys = e.target.result;
        if(!keys.length) return alert("æ— æ—§æ•°æ®");
        keys.forEach(key=>store.delete(key));
        tx.oncomplete=()=>{ alert(`æ¸…ç†äº† ${keys.length} æ¡`); doSearch(); updateStorageInfo(); };
      };
    }

    function clearAllData() {
      if(!confirm("âš ï¸ ç¡®å®šæ¸…ç©ºæ‰€æœ‰ï¼Ÿ")) return;
      if(db) db.close();
      indexedDB.deleteDatabase(DB_NAME).onsuccess=()=>{ alert("å·²æ¸…ç©º"); location.reload(); };
    }

    // ---------- ğŸ iOS æ‰«æå‹åŠ›æµ‹è¯•ï¼šè‡ªåŠ¨æ¢å‚æ•° ----------
    let testing = false;
    function setTestBadge(on){
      const el = document.getElementById('test-badge');
      el.innerText = on ? 'ON' : 'OFF';
      el.className = on ? 'text-pink-300 font-bold' : 'text-gray-500';
      document.getElementById('ios-test-btn').disabled = on;
      document.getElementById('ios-test-btn').classList.toggle('opacity-50', on);
    }

    async function runIosScanTest() {
      if (!isIOS) {
        alert("è¿™å¥—æµ‹è¯•ä¸»è¦ç»™ iOS ç”¨ï¼Œå®‰å“æœ¬æ¥å°±èƒ½ç§’æ‰«ã€‚");
        return;
      }

      if (testing) return;
      testing = true;
      setTestBadge(true);
      log("ğŸ å¼€å§‹ iOS æ‰«æå‹åŠ›æµ‹è¯•ï¼šå°†ä¾æ¬¡åˆ‡æ¢ 4 ç»„å‚æ•°ï¼Œæ¯ç»„çº¦ 8 ç§’", 'warn');

      const presets = [
        {
          name: "P1: å¤§qrbox + 720p + fps12",
          constraints: { width:{ideal:1280}, height:{ideal:720} },
          config: { fps: 12, qrbox: null, aspectRatio: 16/9, disableFlip: true } // FULL ç”»é¢
        },
        {
          name: "P2: å¤§qrbox(åŠ¨æ€) + 720p + fps15",
          constraints: { width:{ideal:1280}, height:{ideal:720} },
          config: { fps: 15, aspectRatio: 16/9, disableFlip: true } // ç”¨ build é»˜è®¤åŠ¨æ€ qrbox
        },
        {
          name: "P3: 1080p + fps10ï¼ˆæ›´æ¸…æ™°ä½†æ›´åƒæ€§èƒ½ï¼‰",
          constraints: { width:{ideal:1920}, height:{ideal:1080} },
          config: { fps: 10, qrbox: null, aspectRatio: 16/9, disableFlip: true }
        },
        {
          name: "P4: 720p + fps8ï¼ˆæ›´çœæ€§èƒ½ï¼‰",
          constraints: { width:{ideal:1280}, height:{ideal:720} },
          config: { fps: 8, qrbox: null, aspectRatio: 16/9, disableFlip: true }
        }
      ];

      try {
        for (let i=0;i<presets.length;i++){
          const p = presets[i];
          log(`ğŸ§ª æµ‹è¯• ${i+1}/${presets.length}: ${p.name}`, 'warn');

          // ç¡®ä¿åœå¹²å‡€
          if (isRunning) await stopPipeline();

          // å¯åŠ¨è¯¥ preset
          await startPipeline({ constraints: p.constraints, config: p.config });

          // è·‘ 8 ç§’
          await waitMs(8000);

          // å¦‚æœè¿™æ®µæ—¶é—´æœ‰å‘½ä¸­ï¼Œå°±æ ‡è®°ä¸€ä¸‹
          log(`ğŸ§ª ${p.name} ç»“æœï¼šhit=${scanStat.hit}, native=${scanStat.nativeHit}`, 'success');
        }
      } catch(e) {
        log("iOS æµ‹è¯•æ¨¡å¼å¼‚å¸¸: " + e, 'error');
      } finally {
        // æµ‹å®Œå›åˆ°â€œæ­£å¸¸æ¨¡å¼â€å¯åŠ¨ä¸€æ¬¡ï¼ˆç”¨é»˜è®¤é€»è¾‘ï¼‰
        if (isRunning) await stopPipeline();
        log("ğŸ iOS æ‰«æå‹åŠ›æµ‹è¯•ç»“æŸï¼šå·²å›åˆ°å¾…æœºçŠ¶æ€", 'success');
        testing = false;
        setTestBadge(false);
      }
    }

    function waitMs(ms){ return new Promise(r=>setTimeout(r, ms)); }

    // ---------- é¡µé¢å¯åŠ¨ ----------
    window.onload = () => { initDB(); updateHealth(); };
  </script>
</body>
</html>
